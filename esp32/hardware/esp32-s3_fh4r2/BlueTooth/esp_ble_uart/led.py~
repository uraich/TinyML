from esp_ble_uart import *
from time import sleep_ms
import machine
from neopixel import NeoPixel
import sys

try:
    from hw_esp32_s3_fh4r2 import *
except:
    print("Please make sure hw_esp32_s3_fh4r2.py has been uploaded to /lib")
    sys.exit()

try:
    switch_led = GRB
except NameError:
    switch_led = False
    
neopixel = NeoPixel(machine.Pin(NEOPIXEL), NO_OF_NEOPIXELS)

nom = 'ESP32-ble-uart'
UUID_UART = '6E400001-B5A3-F393-E0A9-E50E24DCCA9E'
UUID_TX = '6E400003-B5A3-F393-E0A9-E50E24DCCA9E'
UUID_RX = '6E400002-B5A3-F393-E0A9-E50E24DCCA9E'

uart = Bleuart(nom, UUID_UART, UUID_TX, UUID_RX)
uart.close()

val_rx = "20,0,0"

def rec_rx():
    global val_rx
    val_rx = uart.read().decode().strip()
    print('on rx: ', val_rx)        # Interruption : affichage données reçues
    
uart.irq(handler=rec_rx)

def send_tx(val_tx):
    uart.write(str(val_tx) + '\n')
    print("tx", val_tx)

def print_input_error():
    print("Invalid cmd: ",val_rx)
    print("The command should have the form: 'r,g,b' with values of")
    print("0..30 for each color component")
    
print("\nThis program allows setting the LED color via the Serial BlueTooth Terminal")
print("Send a string of the form 'r,g,b', where r,g,b are the color components")
print("The values will be truncated to values between 0 and 30, because otherwise")
print("the LED will be too bright") 
# This is the current color of the led

old_color = val_rx

while True:
    if old_color == val_rx:
        sleep_ms(100)
    else:
            color = val_rx.split(",",3)
            if len(color) != 3:
                print_input_error()
                continue
            
        try:
            if switch_led:
                r = int(color[1])
                g = int(color[0])
            else:
                r = int(color[0])
                g = int(color[1])        
            b = int(color[2])
        except:
            print_input_error()
            continue
    
        # truncate the colors
        if r < 0:
            r = 0 
        if g < 0:
            g = 0
        if b < 0:
            b = 0
        if r > 30:
            r = 30 
        if g > 30:
            g = 30
        if b > 30:
            b = 30
        
        for pixel in range(NO_OF_NEOPIXELS):
            neopixel[pixel] = (r, g, b)
        neopixel.write()
